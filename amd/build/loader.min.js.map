{"version":3,"file":"loader.min.js","sources":["../src/loader.js"],"sourcesContent":["/**\n * AMD-модуль для подгрузки частей лонгрида по AJAX.\n *\n * @module     mod_longread/loader\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine([\"core/ajax\"], function (ajax) {\n  let longreadid, partcount;\n  let currentPart = 1;\n  let loading = false;\n  let container;\n\n  /**\n   * Инициализирует загрузчик частей лонгрида.\n   *\n   * @param {number} lrid Идентификатор экземпляра лонгрида.\n   * @param {number} pcount Общее количество частей.\n   * @return {void}\n   */\n  function init(lrid, pcount) {\n    longreadid = lrid;\n    partcount = pcount;\n    container = document.getElementById(\"longread-content\");\n\n    // Восстанавливаем прокрутку, если есть сохранённое состояние\n    const savedPartId = localStorage.getItem(\"longread_last_part_id_\" + longreadid);\n    if (savedPartId) {\n      scrollToPart(savedPartId);\n    }\n\n    // Подгрузка при прокрутке\n    window.addEventListener(\"scroll\", function () {\n      if (!loading && currentPart < partcount && window.scrollY + window.innerHeight > document.documentElement.scrollHeight - 200) {\n        loadNextPart();\n      }\n    });\n  }\n\n  /**\n   * Прокручивает страницу до указанного элемента.\n   *\n   * @param {string} partId ID элемента, до которого нужно прокрутить.\n   * @return {void}\n   */\n  function scrollToPart(partId) {\n    const target = document.getElementById(partId);\n    if (target) {\n      target.scrollIntoView({ behavior: \"smooth\" });\n\n      // Обновляем текущую часть после прокрутки\n      currentPart = parseInt(partId.split(\"-\").pop(), 10);\n    }\n  }\n\n  /**\n   * Загружает следующую часть по AJAX.\n   *\n   * @param {Function} [callback] Функция, вызываемая после загрузки части.\n   * @return {void}\n   */\n  function loadNextPart(callback) {\n    if (loading) {\n      return;\n    }\n    loading = true;\n\n    ajax\n      .call([\n        {\n          methodname: \"mod_longread_get_part\",\n          args: { longreadid: longreadid, part: currentPart + 1 },\n        },\n      ])[0]\n      .then(function (response) {\n        if (!response.error && response.content.length > 0) {\n          currentPart++;\n          const partId = \"longread-part-\" + currentPart;\n          const partEl = document.createElement(\"div\");\n          partEl.className = \"longread-part\";\n          partEl.id = partId;\n          partEl.innerHTML = \"<br><br>\" + response.content;\n          container.appendChild(partEl);\n\n          // Событие добавления новой части\n          const event = new CustomEvent(\"longread:partadded\", { detail: { el: partEl } });\n          document.dispatchEvent(event);\n\n          // Сохраняем ID последней части\n          localStorage.setItem(\"longread_last_part_id_\" + longreadid, partId);\n\n          // Обновляем прогресс-бар\n          require([\"mod_longread/progress\"], function (progress) {\n            progress.setPart(currentPart);\n          });\n\n          loading = false;\n          if (callback) {\n            callback();\n          }\n        } else {\n          loading = false;\n          if (callback) {\n            callback();\n          }\n        }\n      })\n      .catch(function () {\n        loading = false;\n        if (callback) {\n          callback();\n        }\n      });\n  }\n\n  return {\n    init: init,\n  };\n});\n"],"names":["define","ajax","longreadid","partcount","container","currentPart","loading","init","lrid","pcount","document","getElementById","savedPartId","localStorage","getItem","partId","target","scrollIntoView","behavior","parseInt","split","pop","scrollToPart","window","addEventListener","scrollY","innerHeight","documentElement","scrollHeight","callback","call","methodname","args","part","then","response","error","content","length","partEl","createElement","className","id","innerHTML","appendChild","event","CustomEvent","detail","el","dispatchEvent","setItem","require","progress","setPart","catch","loadNextPart"],"mappings":";;;;;;AAOAA,6BAAO,CAAC,cAAc,SAAUC,UAC1BC,WAAYC,UAGZC,UAFAC,YAAc,EACdC,SAAU,QAyGP,CACLC,cAhGYC,KAAMC,QAClBP,WAAaM,KACbL,UAAYM,OACZL,UAAYM,SAASC,eAAe,0BAG9BC,YAAcC,aAAaC,QAAQ,yBAA2BZ,YAChEU,sBAkBgBG,cACdC,OAASN,SAASC,eAAeI,QACnCC,SACFA,OAAOC,eAAe,CAAEC,SAAU,WAGlCb,YAAcc,SAASJ,OAAOK,MAAM,KAAKC,MAAO,KAvBhDC,CAAaV,aAIfW,OAAOC,iBAAiB,UAAU,YAC3BlB,SAAWD,YAAcF,WAAaoB,OAAOE,QAAUF,OAAOG,YAAchB,SAASiB,gBAAgBC,aAAe,cA4BvGC,aAChBvB,eAGJA,SAAU,EAEVL,KACG6B,KAAK,CACJ,CACEC,WAAY,wBACZC,KAAM,CAAE9B,WAAYA,WAAY+B,KAAM5B,YAAc,MAErD,GACF6B,MAAK,SAAUC,cACTA,SAASC,OAASD,SAASE,QAAQC,OAAS,EAAG,CAClDjC,oBACMU,OAAS,iBAAmBV,YAC5BkC,OAAS7B,SAAS8B,cAAc,OACtCD,OAAOE,UAAY,gBACnBF,OAAOG,GAAK3B,OACZwB,OAAOI,UAAY,WAAaR,SAASE,QACzCjC,UAAUwC,YAAYL,cAGhBM,MAAQ,IAAIC,YAAY,qBAAsB,CAAEC,OAAQ,CAAEC,GAAIT,UACpE7B,SAASuC,cAAcJ,OAGvBhC,aAAaqC,QAAQ,yBAA2BhD,WAAYa,QAG5DoC,QAAQ,CAAC,0BAA0B,SAAUC,UAC3CA,SAASC,QAAQhD,gBAGnBC,SAAU,EACNuB,UACFA,gBAGFvB,SAAU,EACNuB,UACFA,cAILyB,OAAM,WACLhD,SAAU,EACNuB,UACFA,cA5EF0B"}