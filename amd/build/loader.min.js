/**
 * AMD-модуль для подгрузки частей лонгрида по AJAX.
 *
 * @module     mod_longread/loader
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("mod_longread/loader",["core/ajax"],(function(ajax){let longreadid,partcount,container,currentPart=1,loading=!1;return{init:function(lrid,pcount){longreadid=lrid,partcount=pcount,container=document.getElementById("longread-content");const savedPartId=localStorage.getItem("longread_last_part_id_"+longreadid);savedPartId&&function(partId){const target=document.getElementById(partId);target&&(target.scrollIntoView({behavior:"smooth"}),currentPart=parseInt(partId.split("-").pop(),10))}(savedPartId),window.addEventListener("scroll",(function(){!loading&&currentPart<partcount&&window.scrollY+window.innerHeight>document.documentElement.scrollHeight-200&&function(callback){if(loading)return;loading=!0,ajax.call([{methodname:"mod_longread_get_part",args:{longreadid:longreadid,part:currentPart+1}}])[0].then((function(response){if(!response.error&&response.content.length>0){currentPart++;const partId="longread-part-"+currentPart,partEl=document.createElement("div");partEl.className="longread-part",partEl.id=partId,partEl.innerHTML="<br><br>"+response.content,container.appendChild(partEl);const event=new CustomEvent("longread:partadded",{detail:{el:partEl}});document.dispatchEvent(event),localStorage.setItem("longread_last_part_id_"+longreadid,partId),require(["mod_longread/progress"],(function(progress){progress.setPart(currentPart)})),loading=!1,callback&&callback()}else loading=!1,callback&&callback()})).catch((function(){loading=!1,callback&&callback()}))}()}))}}}));

//# sourceMappingURL=loader.min.js.map